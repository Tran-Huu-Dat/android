package com.example.ontap_diemx;

import android.graphics.Color;
import android.os.Bundle;
import android.view.View;
import android.view.ViewGroup;
import android.widget.Button;
import android.widget.TextView;
import android.widget.Toast;

import androidx.activity.EdgeToEdge;
import androidx.appcompat.app.AppCompatActivity;
import androidx.core.graphics.Insets;
import androidx.core.view.ViewCompat;
import androidx.core.view.WindowInsetsCompat;

import java.io.BufferedReader;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.InputStreamReader;
import java.io.OutputStreamWriter;

public class Bon_Mua extends AppCompatActivity {
    private TextView tvwXuan, tvwHa, tvwThu, tvwDong;
    private Button btnSave, btnLoad;
    private TextView[] tvws;
    private String[] muas = new String[]{"Xuan", "Ha", "Thu", "Dong"};
    private int[] maus = new int[]{Color.GREEN, Color.YELLOW, Color.RED, Color.BLUE};
    private int offset = 0;

    private void findViews(){
        tvwXuan = findViewById(R.id.tvwXuan);
        tvwHa = findViewById(R.id.tvwHa);
        tvwThu = findViewById(R.id.tvwThu);
        tvwDong = findViewById(R.id.tvwDong);
        tvws = new TextView[]{tvwXuan, tvwHa, tvwThu, tvwDong};
        btnLoad = findViewById(R.id.btnLoad);
        btnSave = findViewById(R.id.btnSave);
    }
    private void addEvents(){
        for(TextView tv : tvws){
            tv.setOnClickListener(new View.OnClickListener() {
                @Override
                public void onClick(View v) {

                    xuLy(tv);
                }
            });
        }
        btnSave.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                writeFile();
            }
        });
        btnLoad.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                readFile();
            }
        });
    }
    private int getTextViewSelected(){
        for(int i=0; i< tvws.length; i++){
            if(tvws[i].getLayoutParams().height >= dpToPx(120)){
                return i;
            }
        }
        return -1;
    }
    private void writeFile(){
        try{
            FileOutputStream stream = openFileOutput("data.txt", MODE_PRIVATE);
            OutputStreamWriter writer = new OutputStreamWriter(stream);
            writer.write(offset + "\n");
            writer.write(getTextViewSelected() + "\n");

            writer.close();
            stream.close();
            Toast.makeText(this, "Luu file thanh cong", Toast.LENGTH_SHORT).show();
        }
        catch(Exception ex){
            Toast.makeText(this, "Luu file that bai: " + ex.toString(), Toast.LENGTH_SHORT).show();
        }
    }
    private void readFile(){
        try{
            FileInputStream stream = openFileInput("data.txt");
            InputStreamReader streamreader = new InputStreamReader(stream);
            BufferedReader reader = new BufferedReader(streamreader);

            offset = Integer.parseInt(reader.readLine().toString());
            int tvselected = Integer.parseInt(reader.readLine().toString());
            for(int i=0; i<tvws.length; i++){
                int index = (i + offset) % tvws.length;
                tvws[i].setBackgroundColor(maus[index]);
                tvws[i].setText(muas[index]);
            }
            if(tvselected != -1){
                setAllSize(100);
                setSize(tvws[tvselected], 150);
            }
        }
        catch(Exception ex){
            Toast.makeText(this, "Doc file that bai: " +ex.toString(), Toast.LENGTH_SHORT).show();
        }
    }
    private void xuLy(TextView tv){
        offset = (offset + 1) % tvws.length;
        for(int i=0; i<tvws.length; i++){
            int index = (i + offset) % tvws.length;
            tvws[i].setBackgroundColor(maus[index]);
            tvws[i].setText(muas[index]);
        }
        setAllSize(100);
        setSize(tv, 150);
    }
    private void setAllSize(int size){
        for(TextView tv : tvws){
            setSize(tv, 100);
        }
    }
    private void setSize(TextView v,int size){
        ViewGroup.LayoutParams p = v.getLayoutParams();
        p.width = dpToPx(size);
        p.height = dpToPx(size);
        v.setLayoutParams(p);
    }
    private int dpToPx(int dp){
        return (int)(dp * getResources().getDisplayMetrics().density);
    }

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        EdgeToEdge.enable(this);
        setContentView(R.layout.activity_bon_mua);
        ViewCompat.setOnApplyWindowInsetsListener(findViewById(R.id.main), (v, insets) -> {
            Insets systemBars = insets.getInsets(WindowInsetsCompat.Type.systemBars());
            v.setPadding(systemBars.left, systemBars.top, systemBars.right, systemBars.bottom);
            return insets;
        });
        findViews();
        addEvents();
    }
}